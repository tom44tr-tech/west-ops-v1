{% extends "base.html" %}
{% block title %}Smart Email{% endblock %}

{% block content %}

<div class="flex flex-col h-[90vh] container mx-auto px-4 py-6 overflow-hidden">

    <div class="flex justify-between items-end mb-6 shrink-0">
        <div>
            <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-300 text-xs font-bold uppercase tracking-wider mb-2">
                <i data-lucide="mail" class="w-3 h-3"></i> Automatisation
            </span>
            <h1 class="text-3xl font-extrabold text-white">Smart Emailing</h1>
            <p class="text-gray-400 text-sm mt-1">G√©n√©rez et envoyez vos emails de tourn√©e en un clic.</p>
        </div>
        
        <div class="flex items-center gap-3">
            <label class="text-sm text-gray-400">Mod√®le :</label>
            <select id="templateSelector" onchange="updatePreview()" class="bg-white/5 border border-white/10 rounded-lg text-white text-sm px-4 py-2 focus:outline-none focus:border-blue-500 transition">
                <option value="intro">üëã Prise de Contact (Avant tourn√©e)</option>
                <option value="confirm">‚úÖ Confirmation de Passage (J-1)</option>
                <option value="missed">üö´ Client Absent (Apr√®s passage)</option>
            </select>
        </div>
    </div>

    {% if clients %}
    <div class="flex flex-1 gap-6 overflow-hidden min-h-0">
        
        <aside class="w-1/3 glass-card rounded-2xl flex flex-col overflow-hidden border border-white/5">
            <div class="p-4 border-b border-white/5 bg-white/5">
                <h3 class="font-bold text-white text-sm flex items-center gap-2">
                    <i data-lucide="users" class="w-4 h-4 text-blue-400"></i>
                    Destinataires ({{ clients|length }})
                </h3>
            </div>
            
            <div class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-2">
                {% for client in clients %}
                <button onclick="selectClient({{ loop.index0 }})" 
                        id="btn-client-{{ loop.index0 }}"
                        class="client-card w-full text-left p-4 rounded-xl border border-transparent hover:bg-white/5 transition group relative">
                    
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-bold text-gray-200 text-sm truncate pr-4">{{ client.name }}</span>
                        <span class="text-[10px] uppercase font-bold text-blue-400 bg-blue-500/10 px-2 py-0.5 rounded">{{ client.day }}</span>
                    </div>
                    
                    <div class="flex items-center gap-2 text-xs text-gray-500">
                        <i data-lucide="map-pin" class="w-3 h-3"></i> {{ client.city }}
                    </div>

                    <div class="absolute left-0 top-0 bottom-0 w-1 bg-blue-500 rounded-l-xl opacity-0 transition-opacity group-hover:opacity-50 selected-indicator"></div>
                </button>
                {% endfor %}
            </div>
        </aside>

        <main class="flex-1 glass-card rounded-2xl flex flex-col border border-white/5 relative overflow-hidden">
            
            <div class="absolute top-0 right-0 p-32 bg-blue-600/5 blur-3xl rounded-full pointer-events-none"></div>

            <div class="p-4 border-b border-white/5 flex justify-between items-center bg-white/5 relative z-10">
                <div class="flex items-center gap-3">
                    <div class="h-8 w-8 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center font-bold text-xs text-white" id="preview-avatar">
                        --
                    </div>
                    <div>
                        <p class="text-sm font-bold text-white" id="preview-name">S√©lectionnez un client</p>
                        <p class="text-xs text-gray-400" id="preview-email">...</p>
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <button onclick="copyToClipboard()" class="p-2 hover:bg-white/10 rounded-lg text-gray-400 hover:text-white transition" title="Copier le texte">
                        <i data-lucide="copy" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <div class="flex-1 p-8 flex flex-col gap-4 relative z-10 overflow-y-auto">
                
                <div class="space-y-1">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">Objet</label>
                    <input type="text" id="emailSubject" class="w-full bg-transparent border-b border-white/10 py-2 text-lg font-medium text-white focus:outline-none focus:border-blue-500 transition" value="">
                </div>

                <div class="space-y-1 flex-1 flex flex-col">
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">Message</label>
                    <textarea id="emailBody" class="w-full flex-1 bg-transparent border-none resize-none text-gray-300 leading-relaxed focus:outline-none text-sm font-mono" spellcheck="false"></textarea>
                </div>

            </div>

            <div class="p-6 border-t border-white/5 bg-white/5 flex justify-end gap-4 relative z-10">
                <a id="mailtoLink" href="#" target="_blank" class="btn-gradient px-6 py-3 rounded-xl text-white font-bold shadow-lg flex items-center gap-2 hover:scale-105 transition-transform">
                    <i data-lucide="send" class="w-4 h-4"></i> Ouvrir dans Outlook / Mail
                </a>
            </div>

        </main>
    </div>
    {% else %}
    <div class="flex-1 flex flex-col items-center justify-center text-center">
        <div class="h-20 w-20 bg-white/5 rounded-full flex items-center justify-center mb-6">
            <i data-lucide="inbox" class="w-10 h-10 text-gray-600"></i>
        </div>
        <h2 class="text-2xl font-bold text-white mb-2">Aucune tourn√©e active</h2>
        <p class="text-gray-400 max-w-md mx-auto mb-8">
            Pour utiliser le Smart Email, vous devez d'abord g√©n√©rer un planning optimis√©.
        </p>
        <a href="/planner" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-xl text-white font-bold transition">
            Aller au Planificateur
        </a>
    </div>
    {% endif %}

</div>

<script>
    const clientsData = {{ clients|tojson }};
    let currentClient = null;

    // --- TEMPLATES ---
    const templates = {
        'intro': {
            subject: "Passage pr√©vu dans vos locaux - West-Ops",
            body: (c) => `Bonjour,\n\nJe serai de passage √† ${c.city} ce ${c.day} ${c.moment} pour ma tourn√©e hebdomadaire.\n\nAuriez-vous quelques minutes √† m'accorder pour faire le point sur vos besoins actuels ?\n\nBien cordialement,\n\nVotre Commercial West-Ops`
        },
        'confirm': {
            subject: "Confirmation de notre RDV - West-Ops",
            body: (c) => `Bonjour,\n\nJe vous confirme mon passage ce ${c.day} ${c.moment} √† vos bureaux de ${c.city}.\n\n√Ä tr√®s vite,\n\nVotre Commercial West-Ops`
        },
        'missed': {
            subject: "Je suis pass√© vous voir - West-Ops",
            body: (c) => `Bonjour,\n\nJe suis pass√© vous voir ce ${c.day} ${c.moment} mais je n'ai pas pu vous croiser.\n\nN'h√©sitez pas √† me rappeler si vous avez des besoins urgents.\n\nCordialement,`
        }
    };

    function selectClient(index) {
        currentClient = clientsData[index];
        
        // Update UI Selected State
        document.querySelectorAll('.client-card').forEach((el, i) => {
            if (i === index) {
                el.classList.add('bg-white/10', 'border-blue-500/30');
                el.querySelector('.selected-indicator').classList.add('opacity-100');
            } else {
                el.classList.remove('bg-white/10', 'border-blue-500/30');
                el.querySelector('.selected-indicator').classList.remove('opacity-100');
            }
        });

        // Update Preview Header
        document.getElementById('preview-name').innerText = currentClient.name;
        document.getElementById('preview-email').innerText = currentClient.email; // Placeholder
        document.getElementById('preview-avatar').innerText = currentClient.name.substring(0, 2).toUpperCase();

        updatePreview();
    }

    function updatePreview() {
        if (!currentClient) return;

        const templateKey = document.getElementById('templateSelector').value;
        const template = templates[templateKey];

        // Remplissage dynamique
        const subject = template.subject;
        const body = template.body(currentClient);

        document.getElementById('emailSubject').value = subject;
        document.getElementById('emailBody').value = body;

        updateMailtoLink();
    }

    function updateMailtoLink() {
        const subject = encodeURIComponent(document.getElementById('emailSubject').value);
        const body = encodeURIComponent(document.getElementById('emailBody').value);
        // On g√©n√®re le lien mailto
        const link = `mailto:?subject=${subject}&body=${body}`;
        document.getElementById('mailtoLink').href = link;
    }

    function copyToClipboard() {
        const body = document.getElementById('emailBody');
        body.select();
        document.execCommand('copy');
        alert("Message copi√© !");
    }

    // S√©lectionner le premier client par d√©faut au chargement
    if (clientsData.length > 0) {
        selectClient(0);
    }

    // √âcouter les changements manuels dans les champs pour mettre √† jour le lien mailto
    document.getElementById('emailSubject').addEventListener('input', updateMailtoLink);
    document.getElementById('emailBody').addEventListener('input', updateMailtoLink);

</script>

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
</style>

{% endblock %}